// @bun
import{readdirSync as tt,rmSync as nt,statSync as it,unlinkSync as rt,watch as ot}from"fs";import ft from"path";import{mkdirSync as a,writeFileSync as Xn,existsSync as v}from"fs";var Q=(t)=>typeof t==="function";var M=(t)=>{return!isNaN(parseFloat(t))&&isFinite(t)};var B=(t)=>Array.isArray(t),R=(t)=>typeof t==="object";var X=(t)=>{return Number.isInteger(Number(t))};class F{static set p(t){if(Array.isArray(t))console.log(...t);else console.log(t)}}class N{_c=0;_id="";constructor(t){if(this._c=0,this._id=t??W(5),t?.includes("-")){let[n,i]=[t.split("-").slice(0,-1).join("-"),t.split("-").slice(-1)[0]];this._id=n,this._c=M(i)?parseInt(i):0}}get id(){return this._id+"-"+this._c}get mid(){return this._id+"-"+ ++this._c}}var Et=new RegExp(/(\d+)(\d*)/,"m"),y=(t)=>Array.from({length:t},(n,i)=>i),K="ABCDEFGHIJKLMNOPQRSTUVWXYZ",P="abcdefghijklmnopqrstuvwxyz",A=y(10).join("");var T=(t)=>JSON.stringify(t),Z=(t)=>{return JSON.parse(t)},q=(t)=>{if(t.startsWith("webkit"))t="-"+t;return t.replace(/([a-z])([A-Z])/g,"$1-$2").toLowerCase()},W=(t)=>{let n=K+P;return Array.from({length:t},(i,r)=>n+(r?A:"")).reduce((i,r)=>{return i+=r.charAt(Math.floor(Math.random()*r.length))},"")};class u extends Map{obj(t){t&&f(t).forEach(([n,i])=>this.set(n,i))}map(t){t.forEach((n,i)=>{if(n instanceof u)this.set(i,n);else if(B(n)){if(this.lacks(i))this.set(i,[]);this.get(i).push(...n)}else if(R(n))this.ass(i,n);else this.set(i,n)})}ass(t,n){if(!this.has(t))this.set(t,{});I(this.get(t),n)}lacks(t){return!this.has(t)}init(t,n){return this.has(t)?this.get(t):this.set(t,n).get(t)}}var{entries:f,fromEntries:w,hasOwn:_}=Object;var I=Object.assign;var D=(t,n)=>{return{name:t,content:n}},d=(t,n)=>{return{property:t,content:n}},V=(t,n)=>{return{"http-equiv":t,content:n}};class U{metas=[];constructor(t){t&&this.metas.push(D("description",t))}author(t){return this.meta=D("author",t),this}charset(t){return this.meta={charset:t},this}keywords(...t){return this.meta=D("keywords",t.join(", ")),this}viewport(t){let n=f(t).map(([i,r])=>[q(i),String(r)].join("="));return this.meta=D("viewport",n.join(", ")),this}httpEquiv(t){return f(t).forEach(([n,i])=>{this.meta=V(q(n),String(i))}),this}robots(...t){return this.meta=D("robots",t.join(", ")),this}themeColor(t){return this.meta=D("theme-color",t),this}openGraph(t){return f(t).forEach(([n,i])=>{this.meta=d("og:"+n,String(i))}),this}twitter(t){return f(t).forEach(([n,i])=>{this.meta=D("twitter:"+n,String(i))}),this}and(t){return this}set meta(t){this.metas.push(t)}}var j=["charset","name","property","http-equiv"],H=(t,n)=>{n.forEach((i)=>{for(let r of j)if(r in i){let o=i[r];t[`${r}_${r==="charset"?"":o}`]=i}})},p=(t,n)=>{n.forEach((i)=>{if("href"in i){let r=i.href;t[`${r}`]=i}})};class C{_head;idm;constructor(t){this._head=new u(t)}set head(t){f(t).forEach(([n,i])=>{if(n==="title"||n==="base"){if(i!==void 0)this._head.set(n,i);return}if(i instanceof U)return H(this._head.init("meta",{}),i.metas);if(!B(i))return;switch(n){case"meta":return H(this._head.init("meta",{}),i);case"link":return p(this._head.init("link",{}),i);case"script":if(i.length){this._head.init(n,[]);let r=i.map((o)=>{if(!o.yid&&this.idm)o.yid="sc"+this.idm.mid;return o});this._head.get(n).push(...r)}return}})}get head(){return this._head}set id(t){this.idm=new N(t)}}class c{lang="en";htmlHead=new u;head;constructor(){this.head=(t={})=>{let n=new C(this.htmlHead);n.head=t,this.htmlHead=n.head}}}var O=(t,n=!1)=>{if(M(t))return[+t,X(t)?"int":"float"];if(n&&/\.\w+$/.test(t))return[t,"file"];if(t==="/")return[t,"-"];if(t.length===36&&t.match(/\-/g)?.length===4)return[t,"uuid"];return[t,"string"]},Y=(t)=>{let n=t.startsWith("/")?t:"/"+t,i=n.match(/(?<=\/)[^/].*?(?=\/|$)/g)??["/"],[r,o]=i.reduce(([s,x],g)=>{if(g.includes("<")){let h=g.match(/(?<=<)[^/].*?(?=>|$)/g);if(h?.length){let[E,J]=h[0].split(":");if(E&&J)s.push(E),x.push(J)}}else s.push(g===">"?"/":g);return[s,x]},[[],[]]);if(n.endsWith("/")&&n.length>1)r.push("/");return{parsed:r,args:o}};class G{storage=new u;cache(t,n){if(this.storage.lacks(t))this.storage.set(t,n());return this.storage.get(t)}}var e=["int","float","file","uuid","string"],k=new G;class z{_storage=new u;set(t){let{parsed:n,path:i}=t,r=T(n);if(!this._storage.get(r))this._storage.set(r,t);else throw`path: ${i} already used.`}get(t){let{parsed:n}=k.cache(t,()=>Y(t)),i={},r=this._storage.get(T(n));if(!r&&t!=="/")for(let o of this._storage.keys()){let s=[],x=Z(o);if(n.length===x.length){let g=x.map((J,b)=>{let $=O(n[b],n.length-1===b);if(J===$[0])return $[0];if(e.includes($[1]))return s.push($[0]),$[1];return J}),h=T(g);if(this._storage.has(h)){r=this._storage.get(h),r?.args.forEach((J,b)=>{i[J]=s[b]});break}}}return[r,i]}}var L=(t)=>{if(v(t))return!0;return a(t,{recursive:!0}),!0};class l{dir;out;files;external;drop;target;define;exclude=["index.html"];hashAsset;plugins=[];clearing=!1;constructor({files:t,target:n="browser",define:i={},hashAsset:r,external:o=[],drop:s=[],plugins:x=[],out:g="./app",dir:h="./src"}){this.out=g,this.dir=h,this.files=t.map((E)=>(this.dir+"/"+E).replaceAll("//","/")),this.hashAsset=r==null?!0:r,this.external=o,this.drop=s,this.plugins=x,L(this.out),this.target=n,this.define=i}clear(t={exclude:[]}){t.exclude.length&&this.exclude.push(...t.exclude),this.clearing=!0;let n=(i)=>{let r=tt(i);if(r.length==0){nt(i,{recursive:!0});return}r.forEach((o)=>{if(o.startsWith(".")||this.exclude.includes(o))return;let s=ft.join(i,o);if(it(s).isDirectory())n(s);else rt(s)})};return n(this.out),this}build(){let t=`[dir]/[name]${this.hashAsset?"-[hash]":""}.[ext]`;if(this.files.length)Bun.build({entrypoints:this.files,outdir:this.out,splitting:!0,minify:{identifiers:!0,whitespace:!0,syntax:!0},target:this.target??"browser",naming:{chunk:"[dir]/[name]-[hash].[ext]",entry:"[dir]/[name].[ext]",asset:t},define:{...st(this.define)},loader:{".css":"file"},external:this.external,drop:this.drop,plugins:this.plugins}).then((n)=>{if(n.success){let i=new Date().toLocaleTimeString();F.p=`builder @ ${i}`}else F.p=n.logs}).catch((n)=>{F.p=n});return this}watch(t){let n=ot(this.dir,{recursive:!0},async(i,r)=>{if(r&&r.endsWith("tsx")){this.clearing&&this.clear();try{this.build()}catch(o){console.error(o)}}t?.(i,r)});process.on("SIGINT",()=>{console.log(`
watcher closed...`),n.close(),process.exit(0)})}}var st=(t)=>{return w(f(t).map(([n,i])=>{let r=i;if(Q(i))r=i();return[n,T(r)]}))};export{l as default};
